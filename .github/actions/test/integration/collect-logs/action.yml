name: collect-logs
description: Store debugging information for offline analysis
runs:
  using: "composite"
  steps:
    - name: Obtain logs from test runner
      shell: bash
      run: |
        sudo cp /var/log/libvirt/qemu/HV1.log "libvirt-HV1.log" || true
        sudo cp /var/log/libvirt/qemu/HV2.log "libvirt-HV2.log" || true
        sudo journalctl --no-pager > journal-RUNNER.log || true

    - name: Obtain logs from hypervisors
      shell: bash
      run: |
        KEY=/opt/ssh_host_ed25519_key
        SSH_OPTS="-i $KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        USER="root"
        HV1_IP="192.168.122.2"
        HV2_IP="192.168.122.3"

        ssh $SSH_OPTS $USER@$HV1_IP "journalctl --no-pager" > "journal-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/qemu/VM-QEMU.log "libvirt-VM-QEMU-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/ch/VM-CHV.log "libvirt-VM-CHV-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/QEMU.log "serial-VM-QEMU-HV1.log" || true

        ssh $SSH_OPTS $USER@$HV2_IP "journalctl --no-pager" > "journal-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/qemu/VM-QEMU.log "libvirt-VM-QEMU-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/ch/VM-CHV.log "libvirt-VM-CHV-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/QEMU.log "serial-VM-QEMU-HV2.log" || true

    - name: Set permissions
      shell: bash
      run: |
        sudo chmod 644 *.log

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs
        path: "*.log"

