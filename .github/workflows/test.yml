name: test hypervisor capabilities
on:
  push:
    branches:
      - feat/ci-test-cloud-hypervisor
  workflow_run:
    workflows:
      - nightly
      - dev
    types:
      - completed
  # Manual trigger with optional specific image tag
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to test (must be usi-sci). Leave empty to use latest nightly."
        type: string
        default: ""

jobs:
  prepare_image:
    runs-on: ubuntu-latest
    # Only run for workflow_run events from dev workflow on same-repo PRs
    if: github.event_name == 'workflow_run' && github.event.workflow.name == 'dev' && github.event.pull_requests != null && github.event.pull_requests[0].head.repo.full_name == github.repository
    permissions:
      packages: write
      contents: read
    outputs:
      image_tag: ${{ steps.publish.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get PR info
        id: pr_info
        run: |
          PR_NUMBER="${{ github.event.pull_requests[0].number }}"
          SHORT_SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      - name: Download build artifacts
        id: download
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: build-metal-sci_usi-amd64.zip
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - name: Check download success
        if: steps.download.outcome == 'failure'
        run: |
          echo "âŒ Failed to download build artifacts from dev workflow"
          echo "This could be because:"
          echo "  - The dev workflow failed to produce artifacts"
          echo "  - The artifact has expired (artifacts have a retention period)"
          echo "  - Insufficient permissions to access the artifact"
          echo ""
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "Expected artifact name: build-metal-sci_usi-amd64.zip"
          exit 1
      - name: Extract and prepare image components
        id: extract
        run: |
          # Check if artifact file exists
          if [[ ! -f "build-metal-sci_usi-amd64.zip" ]]; then
            echo "âŒ Artifact file build-metal-sci_usi-amd64.zip not found"
            echo "Available files:"
            ls -la
            exit 1
          fi

          # Extract the zip archive
          echo "ðŸ“¦ Extracting build artifacts..."
          unzip -l build-metal-sci_usi-amd64.zip | head -10  # Show first 10 files for debugging
          unzip build-metal-sci_usi-amd64.zip

          # Find UKI and rootfs files
          echo "ðŸ” Looking for UKI (.efi) and rootfs (.tar) files..."
          UKI_FILE=$(find . -name "*.efi" | head -1)
          ROOTFS_FILE=$(find . -name "*.tar" ! -name "build-metal-sci_usi-amd64.zip" | head -1)

          echo "Found files:"
          find . -name "*.efi" -o -name "*.tar" | grep -v "build-metal-sci_usi-amd64.zip"

          if [[ -z "$UKI_FILE" ]]; then
            echo "âŒ Could not find UKI file (*.efi)"
            echo "Available .efi files:"
            find . -name "*.efi" || echo "None found"
            exit 1
          fi

          if [[ -z "$ROOTFS_FILE" ]]; then
            echo "âŒ Could not find rootfs file (*.tar, excluding build-metal-sci_usi-amd64.zip)"
            echo "Available .tar files:"
            find . -name "*.tar" || echo "None found"
            exit 1
          fi

          echo "âœ… Found UKI file: $UKI_FILE"
          echo "âœ… Found rootfs file: $ROOTFS_FILE"

          echo "uki_file=$UKI_FILE" >> $GITHUB_OUTPUT
          echo "rootfs_file=$ROOTFS_FILE" >> $GITHUB_OUTPUT
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish temporary PR image
        id: publish
        run: |
          PR_TAG="pr-${{ steps.pr_info.outputs.pr_number }}-${{ steps.pr_info.outputs.short_sha }}-sci_usi-amd64"
          REGISTRY="ghcr.io/gardenlinux/gardenlinux-ccloud"

          echo "ðŸš€ Publishing temporary image with tag: $PR_TAG"
          echo "Registry: $REGISTRY"
          echo "UKI file: ${{ steps.extract.outputs.uki_file }}"
          echo "Rootfs file: ${{ steps.extract.outputs.rootfs_file }}"

          # Verify files exist before pushing
          if [[ ! -f "${{ steps.extract.outputs.uki_file }}" ]]; then
            echo "âŒ UKI file not found: ${{ steps.extract.outputs.uki_file }}"
            exit 1
          fi

          if [[ ! -f "${{ steps.extract.outputs.rootfs_file }}" ]]; then
            echo "âŒ Rootfs file not found: ${{ steps.extract.outputs.rootfs_file }}"
            exit 1
          fi

          # Push to GHCR with error handling
          if oras push "$REGISTRY:$PR_TAG" \
            "${{ steps.extract.outputs.uki_file }}:application/io.gardenlinux.uki" \
            "${{ steps.extract.outputs.rootfs_file }}:application/io.gardenlinux.image.archive.format.tar"; then

            echo "âœ… Successfully published $REGISTRY:$PR_TAG"
            echo "image_tag=$PR_TAG" >> $GITHUB_OUTPUT

            # Verify the image was published
            echo "ðŸ” Verifying published image..."
            oras manifest fetch "$REGISTRY:$PR_TAG" > /dev/null && echo "âœ… Image verification successful"
          else
            echo "âŒ Failed to publish image to GHCR"
            echo "This could be due to:"
            echo "  - Network issues"
            echo "  - Registry permissions"
            echo "  - Invalid file formats"
            echo "  - Registry rate limits"
            exit 1
          fi
  test:
    runs-on: ubuntu-latest
    needs: [prepare_image]
    if: always() # Run even if prepare_image is skipped
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Dependencies
        uses: ./.github/actions/test/integration/dependencies
      - name: Check PR and prepare_image status
        if: github.event_name == 'workflow_run'
        run: |
          if [[ "${{ github.event.pull_requests }}" != "null" && "${{ github.event.pull_requests }}" != "" ]]; then
            if [[ "${{ github.event.pull_requests[0].head.repo.full_name }}" != "${{ github.repository }}" ]]; then
              echo "âš ï¸ This is a fork PR - using nightly image instead of building PR-specific image"
              echo "Fork repo: ${{ github.event.pull_requests[0].head.repo.full_name }}"
              echo "Base repo: ${{ github.repository }}"
            else
              echo "âœ… This is a same-repo PR"
              if [[ "${{ needs.prepare_image.result }}" == "failure" ]]; then
                echo "âš ï¸ prepare_image job failed - falling back to nightly image"
                echo "Check the prepare_image job logs for details"
              elif [[ "${{ needs.prepare_image.result }}" == "skipped" ]]; then
                echo "âš ï¸ prepare_image job was skipped - falling back to nightly image"
              elif [[ "${{ needs.prepare_image.result }}" == "success" ]]; then
                echo "âœ… prepare_image job succeeded - using PR-specific image"
              fi
            fi
          fi
      - name: Determine image tag to use
        id: fetch_tag
        run: |
          # Use tag from prepare_image job if available
          if [[ "${{ needs.prepare_image.outputs.image_tag }}" != "" ]]; then
            echo "Using PR-specific image tag from prepare_image job"
            image_tag="${{ needs.prepare_image.outputs.image_tag }}"
          # Use manual input if provided
          elif [[ "${{ inputs.image_tag }}" != "" ]]; then
            echo "Using manually provided image tag"
            image_tag="${{ inputs.image_tag }}"
          # Fall back to latest nightly tag
          else
            echo "Fetching latest nightly image tag"
            image_tag=$(oras repo tags ghcr.io/gardenlinux/gardenlinux-ccloud | grep 'sci_usi' | sort -r | head -n 1)
          fi

          echo "Selected image tag: $image_tag"
          echo "latest_tag=$image_tag" >> $GITHUB_ENV
      - name: Build
        uses: ./.github/actions/test/integration/build
        with:
          image_tag: ${{ env.latest_tag || inputs.image_tag }}
      - name: Setup
        uses: ./.github/actions/test/integration/setup
      - name: Test QEMU
        uses: ./.github/actions/test/integration/test/qemu
      - name: Test CloudHypervisor
        uses: ./.github/actions/test/integration/test/cloudhypervisor
      - name: Collect Debug Logs
        if: always()
        uses: ./.github/actions/test/integration/collect-logs
