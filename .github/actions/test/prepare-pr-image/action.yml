name: 'Prepare PR Image'
description: 'Downloads build artifacts from dev workflow and publishes temporary PR-specific images to GHCR'
inputs:
  workflow-run-id:
    description: 'The workflow run ID to download artifacts from'
    required: true
  pr-number:
    description: 'Pull request number'
    required: false
    default: ''
  commit-sha:
    description: 'Commit SHA (will be truncated to 7 chars)'
    required: false
    default: ''
  github-token:
    description: 'GitHub token for artifact download and GHCR push'
    required: true
  registry:
    description: 'Container registry URL'
    required: false
    default: 'ghcr.io/gardenlinux/gardenlinux-ccloud'
outputs:
  image-tag:
    description: 'The published image tag'
    value: ${{ steps.publish.outputs.image_tag }}

runs:
  using: 'composite'
  steps:
    - name: Get PR info
      id: pr_info
      shell: bash
      run: |
        PR_NUMBER="${{ inputs.pr-number }}"
        SHORT_SHA="${{ inputs.commit-sha }}"
        SHORT_SHA="${SHORT_SHA:0:7}"
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
    - name: Download build artifacts
      id: download
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: build-metal-sci_usi-amd64
        github-token: ${{ inputs.github-token }}
        run-id: ${{ inputs.workflow-run-id }}
    - name: Check download success
      if: steps.download.outcome == 'failure'
      shell: bash
      run: |
        echo "Failed to download build artifacts from dev workflow"
        exit 1
     - name: Extract and prepare image components
       id: extract
       shell: bash
       run: |
         # The downloaded artifact is already a zip file, extract it
         unzip build-metal-sci_usi-amd64.zip

         UKI_FILE=$(find . -name "*.efi" | head -1)
         ROOTFS_FILE=$(find . -name "*.tar" | head -1)

        if [[ -z "$UKI_FILE" ]]; then
          echo "❌ Could not find UKI file (*.efi)"
          echo "Available .efi files:"
          find . -name "*.efi" || echo "None found"
          exit 1
        fi

         if [[ -z "$ROOTFS_FILE" ]]; then
           echo "❌ Could not find rootfs file (*.tar)"
           echo "Available .tar files:"
           find . -name "*.tar" || echo "None found"
           exit 1
         fi

        echo "uki_file=$UKI_FILE" >> $GITHUB_OUTPUT
        echo "rootfs_file=$ROOTFS_FILE" >> $GITHUB_OUTPUT
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github-token }}
    - name: Publish temporary PR image
      id: publish
      shell: bash
      run: |
        PR_TAG="pr-${{ steps.pr_info.outputs.pr_number }}-${{ steps.pr_info.outputs.short_sha }}-sci_usi-amd64"
        REGISTRY="${{ inputs.registry }}"


        if oras push "$REGISTRY:$PR_TAG" \
          "${{ steps.extract.outputs.uki_file }}:application/io.gardenlinux.uki" \
          "${{ steps.extract.outputs.rootfs_file }}:application/io.gardenlinux.image.archive.format.tar"; then

          echo "image_tag=$PR_TAG" >> $GITHUB_OUTPUT
        else
          echo "Failed to publish image to GHCR"
          exit 1
        fi
