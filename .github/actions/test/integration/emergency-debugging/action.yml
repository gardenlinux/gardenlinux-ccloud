name: emergency-debugging
description: Store debugging information in case of test failure
runs:
  using: "composite"
  steps:
    - name: Obtain logs from test runner
      shell: bash
      run: |
        cp /var/log/libvirt/qemu/*.log . || true
        journalctl --no-pager > journal.log || true

    - name: Obtain logs from hypervisors
      shell: bash
      run: |
        KEY=/opt/ssh_host_ed25519_key
        SSH_OPTS="-i $KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        USER="root"
        HV1_IP="192.168.122.2"
        HV2_IP="192.168.122.3"

        ssh $SSH_OPTS $USER@$HV1_IP "journalctl --no-pager" > "journal-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/qemu/VM-QEMU.log "VM-QEMU-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/ch/VM-CHV.log "VM-CHV-HV1.log" || true

        ssh $SSH_OPTS $USER@$HV2_IP "journalctl --no-pager" > "journal-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/qemu/VM-QEMU.log "VM-QEMU-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/ch/VM-CHV.log "VM-CHV-HV2.log" || true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs
        path: *.log

