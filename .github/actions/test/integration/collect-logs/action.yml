name: collect-logs
description: Store debugging information for offline analysis
runs:
  using: "composite"
  steps:
    - name: Obtain logs from test runner
      shell: bash
      run: |
        sudo lscpu > lscpu-RUNNER.log || true
        sudo lshw > lshw-runner.log || true
        sudo journalctl --no-pager > journal-RUNNER.log || true

        sudo cp /var/log/libvirt/qemu/HV1.log "libvirt-HV1.log" || true
        sudo cp /var/log/libvirt/qemu/HV2.log "libvirt-HV2.log" || true

    - name: Obtain logs from hypervisors
      shell: bash
      run: |
        KEY=/opt/ssh_host_ed25519_key
        SSH_OPTS="-i $KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        USER="root"
        HV1_IP="192.168.122.2"
        HV2_IP="192.168.122.3"

        ssh $SSH_OPTS $USER@$HV1_IP "journalctl --no-pager" > "journal-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/qemu/VM-QEMU.log "libvirt-VM-QEMU-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/libvirt/ch/VM-CHV.log "libvirt-VM-CHV-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/QEMU.log "serial-VM-QEMU-HV1.log" || true
        scp $SSH_OPTS $USER@$HV1_IP:/var/log/CHV.log "serial-VM-CHV-HV1.log" || true

        ssh $SSH_OPTS $USER@$HV2_IP "journalctl --no-pager" > "journal-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/qemu/VM-QEMU.log "libvirt-VM-QEMU-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/libvirt/ch/VM-CHV.log "libvirt-VM-CHV-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/QEMU.log "serial-VM-QEMU-HV2.log" || true
        scp $SSH_OPTS $USER@$HV2_IP:/var/log/CHV.log "serial-VM-CHV-HV2.log" || true

    - name: Set permissions
      shell: bash
      run: |
        sudo chmod 644 *.log

    - name: Collect coredumps from hypervisors
      shell: bash
      run: |
        KEY=/opt/ssh_host_ed25519_key
        SSH_OPTS="-i $KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        USER="root"

        for HV_NAME in HV1 HV2; do
          IP="192.168.122.$([[ $HV_NAME == HV1 ]] && echo 2 || echo 3)"

          ssh $SSH_OPTS $USER@$IP "
            # Only proceed if coredumps exist
            if coredumpctl list --no-legend 2>/dev/null | grep -q .; then
              mkdir -p /tmp/coredumps-$HV_NAME
              for id in \$(coredumpctl list --no-legend 2>/dev/null | awk '{print \$5}'); do
                echo Processing core \$id
                coredumpctl info \$id > /tmp/coredumps-$HV_NAME/info-\$id.txt 2>/dev/null || true
                coredumpctl dump \$id > /tmp/coredumps-$HV_NAME/core-\$id 2>/dev/null || true
              done
            else
              echo 'No coredumps present on $HV_NAME'
            fi
          " || true

          if ssh $SSH_OPTS $USER@$IP "[ -d /tmp/coredumps-$HV_NAME ] && [ -n \"\$(ls /tmp/coredumps-$HV_NAME 2>/dev/null)\" ]"; then
            scp -r $SSH_OPTS $USER@$IP:/tmp/coredumps-$HV_NAME ./ || true
          fi
         done

    - name: Upload debug logs
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs
        path: "*.log"

    - name: Upload coredumps (if any exist)
      uses: actions/upload-artifact@v4
      if: ${{ hashFiles('coredumps-*/**') != '' }}
      with:
        name: coredumps
        path: coredumps-*/
