#!/usr/bin/env bash
set -Eeuo pipefail

# Undo the gardener feature disablement
systemctl enable ssh

# install custom packages
# TODO : these all should go in the repo

# all versions URL encoded
EDK2_VERSION="20250503-7gl0%2Bbp1877"
LIBVIRT_VERSION="11.10.0-2gl2%2Bbp1877"
CLOUD_HYPERVISOR_VERSION="50.0-1gl1%2Bbp1877"

mkdir /tmp/custompackages
for p in https://github.com/gardenlinux/package-edk2-cloud-hypervisor-gl/releases/download/$EDK2_VERSION/build.tar.xz.0000 https://github.com/gardenlinux/package-libvirt/releases/download/$LIBVIRT_VERSION/build.tar.xz.0000 https://github.com/gardenlinux/package-cloud-hypervisor-gl/releases/download/$CLOUD_HYPERVISOR_VERSION/build.tar.xz.0000; do
  echo "Downloading and extracting package from $p"
  wget -q "$p" -O - | xz -d | tar xf - -C /tmp/custompackages
done

pushd /tmp/custompackages > /dev/null
dpkg -i cloud-hypervisor-gl*_amd64.deb edk2-cloud-hypervisor-gl*_amd64.deb libvirt-clients_*_amd64.deb libvirt-common_*_amd64.deb libvirt-daemon_*_amd64.deb libvirt-daemon-common_*_amd64.deb libvirt-daemon-config-network_*_all.deb libvirt-daemon-config-nwfilter_*_all.deb libvirt-daemon-driver-ch-gl_*_amd64.deb libvirt-daemon-driver-network_*_amd64.deb libvirt-daemon-driver-nodedev_*_amd64.deb libvirt-daemon-driver-nwfilter_*_amd64.deb libvirt-daemon-driver-qemu_*_amd64.deb libvirt-daemon-driver-secret_*_amd64.deb libvirt-daemon-driver-storage_*_amd64.deb libvirt-daemon-log_*_amd64.deb libvirt-daemon-system_*_amd64.deb libvirt0_*_amd64.deb
popd > /dev/null
rm -rf /tmp/custompackages

# UID taken from sles 15, looks like it runs as root in debian/gardenlinux
adduser --uid 476 openvswitch \
  --system --group --no-create-home --disabled-password --disabled-login

adduser root openvswitch # Otherwise does not want to run as root:openvswitch

function create() {
  NAME=$1
  shift
  ID=$1
  shift
  adduser --uid $ID --home /var/lib/$NAME $NAME \
    --system --group --disabled-password --disabled-login
  echo "$@"
  for group in "$@"; do
    adduser $NAME $group
  done
}

create openstack 42424
create neutron 42435 openvswitch
create nova 42436 libvirt openvswitch
create kvm-node-agent 42438 libvirt

chsh -s /bin/bash nova
mkdir -p /var/lib/nova/{.ssh,instances,mnt}
chown -R nova:libvirt-qemu /var/lib/nova/{.ssh,instances,mnt}
chmod 0600 /var/lib/nova/.ssh

mkdir -p /etc/pki/CA /etc/pki/libvirt /etc/pki/qemu
chown kvm-node-agent:kvm-node-agent /etc/pki/CA /etc/pki/libvirt /etc/pki/qemu
chmod 0755 /etc/pki/CA /etc/pki/libvirt /etc/pki/qemu

# limit vnc port autorange to possible kubernetes nodeports
sed -i 's/#remote_display_port_min = 5900/remote_display_port_min = 32200/' /etc/libvirt/qemu.conf
sed -i 's/#remote_display_port_max = 65535/remote_display_port_max = 32299/' /etc/libvirt/qemu.conf
